

<%- include("../partials/user/header") %>
<link rel="stylesheet" href="/css/payment.css">



<div class="breadcrumb">
  Home / <strong>Products</strong>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<form id="paymentForm" action="/checkout/payment/place" method="POST">

  <input type="hidden" name="addressId" value="<%= address._id %>">

  <div class="payment-container">

   
    <div class="payment-methods">
      <h3>Select payment method</h3>

      <label class="payment-option">
        <input type="radio" name="paymentMethod" value="Razorpay" checked>
        <span>Razorpay - <%= address.name %></span>
      </label>

      <label class="payment-option">
        <input type="radio" name="paymentMethod" value="UPI">
        <span>UPI Payment</span>
      </label>

      <label class="payment-option">
        <input type="radio" name="paymentMethod" value="Card">
        <span>Credit / Debit Card</span>
      </label>

      <label class="payment-option">
        <input type="radio" name="paymentMethod" value="Wallet">
        <span>Wallets</span>
      </label>

      <label class="payment-option">
        <input type="radio" name="paymentMethod" value="COD">
        <span>Cash on Delivery</span>
      </label>
    </div>
    <div class="order-summary">
      <h3>Order summary</h3>

      <% cartItems.forEach(item => { %>
        <div class="summary-row">
          <span><%= item.productId.productName %> Ã— <%= item.quantity %></span>
<span>
  â‚¹ <%= Number(item.productId.regularPrice) * Number(item.quantity) %>
</span>

        </div>
      <% }) %>

      <hr>

      <div class="summary-row total">
        <strong>Total</strong>
        <strong>â‚¹ <%= total %></strong>
      </div>

      <button type="submit" class="place-order-btn">
        Place Order
      </button>

      <p class="secure-text">
        ðŸ”’ Safe and secure payments. 100% Authentic products
      </p>
    </div>

  </div>
</form>

<script>
  const form = document.getElementById("paymentForm");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(form);

    try {
      const res = await fetch(form.action, {
        method: "POST",
        headers: {
          "Accept": "application/json"
        },
        body: new URLSearchParams(formData)
      });

      const contentType = res.headers.get("content-type");

      if (!contentType || !contentType.includes("application/json")) {
        throw new Error("Response is not JSON");
      }

      const data = await res.json();

      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "Order placed successfully",
          text: "Order placed using wallet successfully",
          confirmButtonText: "OK"
        }).then(() => {
          window.location.href = "/orders";
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Order Failed",
          text: data.message || "Something went wrong"
        });
      }

    } catch (err) {
      console.error("FETCH ERROR ðŸ‘‰", err);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Server error. Please try again."
      });
    }
  });
</script>


<%- include("../partials/user/footer") %>
