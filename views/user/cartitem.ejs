<%- include("../partials/user/header") %>
<link rel="stylesheet" href="/css/cart.css">

<section class="container cart-main">

  <% if (!cart || cart.items.length === 0) { %>

    <div class="empty-cart">Your cart is empty ðŸ˜¢</div>

  <% } else { %>

    <div class="cart-products">
      <% let subtotal = 0; %>

      <% cart.items.forEach(item => { %>
        <%
          const price = item.productId.salePrice || item.productId.regularPrice || 0;
          const qty = item.quantity;
          const total = price * qty;
          subtotal += total;

          const outOfStock = item.productId.stock <= 0;
        %>

        <div class="cart-item <%= outOfStock ? 'out-stock' : '' %>" data-id="<%= item._id %>">

          <img src="<%= item.productId.productImage?.[0] || '/images/default.png' %>" alt="product">

          <div class="item-details">
            <div class="item-name"><%= item.productId.productName %></div>

            <% if (outOfStock) { %>
              <div class="stock-label">Out of Stock</div>
            <% } %>

            <div class="item-price">â‚¹ <%= price %></div>

            <div class="quantity">
              <button class="decrease-qty" <%= outOfStock ? "disabled" : "" %>>-</button>
              <input type="text" class="quantityinfrontend" value="<%= qty %>" readonly>
              <button class="increase-qty" <%= outOfStock ? "disabled" : "" %>>+</button>
            </div>

            <div class="item-total">â‚¹ <%= total %></div>
          </div>

          <button class="delete">âœ•</button>
        </div>
      <% }) %>

      <a href="/shop" class="continue-shopping">Continue Shopping</a>
    </div>

    <div class="cart-summary">
      <h2>Cart Summary</h2>
      <p>Subtotal: <span id="cart-subtotal">â‚¹ <%= subtotal %></span></p>
      <p>Total: <span id="cart-total">â‚¹ <%= subtotal %></span></p>

      <% 
        let hasOutOfStock = false;
        for (let i = 0; i < cart.items.length; i++) {
          if (cart.items[i].productId.stock <= 0) {
            hasOutOfStock = true;
            break;
          }
        }
      %>

      <a href="<%= hasOutOfStock ? 'javascript:void(0)' : '/checkout' %>"
         class="checkout-btn <%= hasOutOfStock ? 'disabled-checkout' : '' %>">
        Checkout
      </a>

      <% if (hasOutOfStock) { %>
        <p class="checkout-warning">
          Remove out-of-stock items to proceed
        </p>
      <% } %>

    </div>

  <% } %>

</section>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  function updateSummary() {
    let subtotal = 0;

    document.querySelectorAll(".cart-item").forEach(item => {
      subtotal += parseFloat(
        item.querySelector(".item-total").textContent.replace("â‚¹", "")
      );
    });

    document.getElementById("cart-subtotal").textContent = `â‚¹ ${subtotal}`;
    document.getElementById("cart-total").textContent = `â‚¹ ${subtotal}`;
  }
  document.querySelectorAll(".delete").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const itemEl = e.target.closest(".cart-item");
      const itemId = itemEl.dataset.id;

      try {
        const res = await fetch("/cart/remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ itemId })
        });

        const data = await res.json();

        if (!res.ok) {
          Swal.fire("Error", data.message || "Remove failed", "error");
          return;
        }

        itemEl.remove();
        updateSummary();

        Swal.fire({
          icon: "success",
          title: "Removed!",
          text: "Item removed from cart",
          timer: 1200,
          showConfirmButton: false
        });

        if (document.querySelectorAll(".cart-item").length === 0) {
          document.querySelector(".cart-main").innerHTML =
            '<div class="empty-cart">Your cart is empty ðŸ˜¢</div>';
        }

      } catch (err) {
        console.error(err);
        Swal.fire("Error", "Something went wrong", "error");
      }
    });
  });

  document.querySelectorAll(".increase-qty, .decrease-qty").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const itemEl = e.target.closest(".cart-item");
      const itemId = itemEl.dataset.id;
      const action = e.target.classList.contains("increase-qty") ? "inc" : "dec";
      //newly added code //
      const quantity = parseInt(itemEl.querySelector(".quantityinfrontend").value) + 1;

      try {
        const res = await fetch("/cart/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ itemId, action, quantity })
        });

        const data = await res.json();
        if (!res.ok) {
          Swal.fire({
            icon: "warning",
            title: "Limit reached",
            text: data.message
          });
          return;
        }

        let qtyInput = itemEl.querySelector("input");
        let qty = parseInt(qtyInput.value);

        qty = action === "inc" ? qty + 1 : Math.max(1, qty - 1);
        qtyInput.value = qty;

        const price = parseFloat(
          itemEl.querySelector(".item-price").textContent.replace("â‚¹", "")
        );

        itemEl.querySelector(".item-total").textContent = `â‚¹ ${price * qty}`;
        updateSummary();

      } catch (err) {
        console.error(err);
        Swal.fire("Error", "Something went wrong", "error");
      }
    });
  });

});
</script>

<%- include("../partials/user/footer") %>
