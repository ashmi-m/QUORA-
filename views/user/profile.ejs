<%- include("../partials/user/header") %>

  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>My Profile | Quora</title>
    <link rel="stylesheet" href="/css/profile.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>

    <div class="breadcrumb">
      Home / My Account
    </div>

    <div class="profile-container">
      <div class="profile-sidebar">
        <div class="profile-image-box">
        <img src="<%= user.profileImage %>" alt="Profile Image" id="profilePreview">
        <input type="file" id="profileImageInput" hidden>
        <button type="button" id="changeImageBtn">Change Photo</button>
      </div>
        <h3>Hello ðŸ‘‹ <%= user?.name %>
        </h3>

        <div class="profile-menu">
          <button class="active" data-target="profileSection">Profile Information</button>
          <button data-target="ordersSection">My Orders</button>
          <button data-target="addressSection">Manage Addresses</button>
          <a href="/forgot-password"><button type="button">Forgot Password</button></a>
          <a href="/logout"><button type="button">Logout</button></a>


        </div>
      </div>

    
      <div class="profile-content">

        <div id="profileSection" class="profile-section">

          <form id="profileForm">
            <div class="profile-actions">
              <button type="button" id="editProfileBtn">Edit Profile</button>
              <button type="button" id="saveProfileBtn" class="hidden">Save Changes</button>
            </div>

            <h2>Personal Information</h2>

            <label>Name</label>
            <input type="text" name="name" value="<%= user.name %>" disabled>

            <div class="row">
              <div>
                <label>Email</label>
                <input type="email" value="<%= user.email %>" disabled>
              </div>

              <div>
                <label>Mobile Number</label>
                <input type="text" name="phone" value="<%= user.phone %>" disabled>
              </div>
            </div>

            <label>Gender</label>
            <div class="gender">
              <label>
                <input type="radio" name="gender" value="Male" disabled <%=user.gender==="Male" ? "checked" : "" %>>
                Male
              </label>

              <label>
                <input type="radio" name="gender" value="Female" disabled <%=user.gender==="Female" ? "checked" : "" %>>
                Female
              </label>
            </div>
          </form>
        </div>
        <div id="ordersSection" class="profile-section hidden">
          <%- include("./orders", { orders: orders }) %>

        </div>
        <div id="addressSection" class="profile-section hidden">

          <%- include("./manageAddress", { addresses: addresses }) %>
        </div>

      </div>
    </div>

    <footer>Â© 2025 Quora - All Rights Reserved</footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const menuButtons = document.querySelectorAll(".profile-menu button[data-target]");
        const sections = document.querySelectorAll(".profile-section");

        menuButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            sections.forEach(sec => sec.classList.add("hidden"));
            document.getElementById(btn.dataset.target).classList.remove("hidden");

            menuButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
          });
        });
        const editBtn = document.getElementById("editProfileBtn");
        const saveBtn = document.getElementById("saveProfileBtn");
        const inputs = document.querySelectorAll(
          "#profileSection input[name='name'], #profileSection input[name='phone'], #profileSection input[name='gender']"
        );

        editBtn.addEventListener("click", () => {
          inputs.forEach(i => i.disabled = false);
          editBtn.classList.add("hidden");
          saveBtn.classList.remove("hidden");
        });

        saveBtn.addEventListener("click", async () => {
          const gender = document.querySelector("input[name='gender']:checked")?.value;

          const data = {
            name: document.querySelector("input[name='name']").value,
            phone: document.querySelector("input[name='phone']").value,
            gender
          };

          const res = await fetch("/profile/update", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const result = await res.json();

          if (result.success) {
            Swal.fire("Success", "Profile updated", "success")
              .then(() => location.reload());
          } else {
            Swal.fire("Error", "Update failed", "error");
          }
        });
        const changeBtn = document.getElementById("changeImageBtn");
      const imageInput = document.getElementById("profileImageInput");
      const preview = document.getElementById("profilePreview");
     
      changeBtn.addEventListener("click", () => imageInput.click());

      imageInput.addEventListener("change", async () => {
        const file = imageInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("profileImage", file);

        const res = await fetch("/profile/upload-image", {
          method: "PUT",
          body: formData
        });
        
        const result = await res.json();

        if (result.success) {
          preview.src = result.image;
          Swal.fire("Success", "Profile image updated", "success");
        } else {
          Swal.fire("Error", "Upload failed", "error");
        }
      });


      });
    </script>

  </body>

  </html>