<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Addresses</title>
  <link rel="stylesheet" href="/css/manage-address.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="profile-container">
  <div class="address-wrapper">

    <div class="address-header">
      <h2>Manage Addresses</h2>
      <a href="/add-address" class="add-address-btn">+ Add New Address</a>
    </div>
     <% if (!user.addresses || user.addresses.length === 0) { %>
      <p>No address found</p>
    <% } %>

    <% user.addresses.forEach(addr => { %>
       <div class="address-card" id="address-<%= addr._id %>">

        <div class="address-info">
          <div>
            <span class="address-name"><%= addr.name.toUpperCase() %></span>
            <span class="address-phone"><%= addr.mobile %></span>
          </div>

          <div class="address-actions">
            <button class="dots-btn">â‹®</button>
            <div class="dropdown-menu">
              <a href="/edit-address/<%= addr._id %>" class="edit-btn">Edit</a>
              <button class="delete-btn" data-id="<%= addr._id %>">Delete</button>
            </div>
          </div>
        </div>

        <p class="address-text">
          <%= addr.address %>, <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %>
        </p>

        <span class="address-type"><%= addr.type %></span>

      </div>
    <% }) %>

  </div>
</div>


<script>
document.addEventListener("click", e => {
  if (e.target.classList.contains("dots-btn")) {
    e.stopPropagation();
    document.querySelectorAll(".dropdown-menu").forEach(d => d.classList.remove("show"));
    e.target.nextElementSibling.classList.toggle("show");
  } else {
    document.querySelectorAll(".dropdown-menu").forEach(d => d.classList.remove("show"));
  }
});

document.querySelectorAll(".delete-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    const result = await Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!"
    });
    
    if (result.isConfirmed) {
      try {
        const res = await fetch(`/address/delete/${id}`, { method: "DELETE", headers: { "Content-Type": "application/json" } });
        const data = await res.json();
        if (data.success) {
          document.getElementById(`address-${id}`).remove();
          Swal.fire({ icon: "success", title: "Deleted!", text: "Address deleted successfully", timer: 2000, showConfirmButton: false });
        } else Swal.fire("Error", "Failed to delete address", "error");
      } catch (err) {
        console.error(err);
        Swal.fire("Error", "Something went wrong", "error");
      }
    }
  });
});
</script>

</body>
</html>
