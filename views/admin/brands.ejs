<%- include("../partials/admin/header",{active : 'categories'}) %>

  <title>Brands</title>
  <style>
    .main-content {
      margin-left: 240px;
      /* Sidebar width */
      margin-top: 70px;
      /* Topbar height */
      padding: 20px;
      background: #f4f6f9;
      min-height: calc(100vh - 70px);
    }

    h1 {
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .brand-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    /* Brand Form */
    .brand-form {
      flex: 1;
      max-width: 250px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .brand-form label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #444;
    }

    .brand-form input[type="text"],
    .brand-form input[type="file"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .brand-form button {
      width: 100%;
      padding: 10px;
      background: #00796b;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .brand-form button:hover {
      background: #004d40;
    }

    /* Brand Table */
    .brand-list {
      flex: 3;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: #00796b;
      color: white;
      font-weight: bold;
    }

    tr:hover {
      background: #f1f1f1;
    }

    td img {
      max-width: 80px;
      max-height: 60px;
      object-fit: contain;
    }

    /* Action Buttons */
    .actions button {
      padding: 6px 10px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.2s;
      color: #fff;
      margin: 2px;
    }

    .btn-delete {
      background: #e53935;
    }

    .btn-block {
      background: #f9a825;
    }

    .btn-unblock {
      background: #43a047;
    }

    .actions button:hover {
      opacity: 0.8;
    }

    /* Pagination */
    .pagination {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .pagination a {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-decoration: none;
      border-radius: 4px;
      color: #333;
    }

    .pagination a.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    @media (max-width: 768px) {
      .brand-container {
        flex-direction: column;
      }

      .brand-form,
      .brand-list {
        max-width: 100%;
      }
    }
  </style>

  <div class="main-content">
    <h1>Brands Management</h1>

    <div class="brand-container">
      <!-- Brand Form -->
      <div class="brand-form">
        <form id="addBrandForm" enctype="multipart/form-data">
          <label for="brandName">Brand Name</label>
          <input type="text" id="brandName" name="brandName" placeholder="Enter brand name" required>

          <label for="brandImage">Brand Logo</label>
          <input type="file" id="brandImage" name="brandImage" accept="image/*" required>

          <button type="submit">Add Brand</button>
        </form>
      </div>

      <!-- Brand Table -->
      <div class="brand-list">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Brand Logo</th>
              <th>Brand Name</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (data.length> 0) { %>
              <% data.forEach((brand, index)=> { %>
                <tr>
                  <td>
                    <%= (currentPage-1) * limit + index + 1 %>
                  </td>
                  <td><img src="<%= brand.brandImage %>" alt="<%= brand.brandName %>"></td>
                  <td>
                    <%= brand.brandName %>
                  </td>
                  <td>
                    <% if (brand.isBlocked) { %>
                      <span style="color:red;font-weight:bold;">Blocked</span>
                      <% } else { %>
                        <span style="color:green;font-weight:bold;">Active</span>
                        <% } %>
                  </td>
                  <td class="actions">
                    <button class="btn-delete" onclick="deleteBrand('<%= brand._id %>')">Delete</button>
                    <% if (brand.isBlocked) { %>
                      <button class="btn-unblock" onclick="unblockBrand('<%= brand._id %>')">Unblock</button>
                      <% } else { %>
                        <button class="btn-block" onclick="blockBrand('<%= brand._id %>')">Block</button>
                        <% } %>
                  </td>
                </tr>
                <% }) %>
                  <% } else { %>
                    <tr>
                      <td colspan="5">No brands found.</td>
                    </tr>
                    <% } %>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
          <% for (let i=1; i <=totalPages; i++) { %>
            <a href="/admin/brands?page=<%= i %>" class="<%= i === currentPage ? 'active' : '' %>">
              <%= i %>
            </a>
            <% } %>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Add Brand
    document.getElementById("addBrandForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const brandName = document.getElementById("brandName").value.trim();
      const brandImage = document.getElementById("brandImage").files[0];
      if (!brandName || !brandImage) {
        Swal.fire(" Oops!", "Please fill all fields", "warning");
        return;
      }
      const formData = new FormData();
      formData.append("brandName", brandName);
      formData.append("brandImage", brandImage);
      try {
        const response = await fetch("/admin/addBrand", { method: "POST", body: formData });
        const data = await response.json();
        if (data.success) {
          Swal.fire("✅ Success", "Brand added successfully!", "success").then(() => {
            location.reload();
          });
          
        document.getElementById("addBrandForm").reset()
        } else {
         Swal.fire("❌ Error", data.error, "error");
        }
      } catch (err) {
        console.error("Upload failed:", err);
        Swal.fire("❌ Error", "Something went wrong", "error");
      }
    });

    // Delete Brand
    function deleteBrand(id) {
      Swal.fire({
      title: "Are you sure?",
      text: "This action cannot be undone!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!"
    }).then(async (res)=>{
     if (res.isConfirmed){
       try {
      const resp = await fetch(`/admin/deleteBrand/${id}`, { method: "DELETE" });
      const data = await resp.json();
      if (data.success) {
        Swal.fire("Deleted!", "Brand has been deleted.", "success").then(() => {
          location.reload();
        });
      } else {
        Swal.fire("❌ Error", data.error, "error");
      }
    } catch (err) {
      console.error(err);
      Swal.fire("❌ Error", "Failed to delete brand", "error");
    }
     }else{
      Swal.fire("Cancelled","Your brand is safe","info");
     }
    });
  }


    // Block Brand
    async function blockBrand(id) {
      try {
        const res = await fetch(`/admin/blockBrand/${id}`, {
          method: "PATCH",
          credentials: "same-origin"
        });

       const data = await res.json();
      if (data.success) {
        Swal.fire("✅ Blocked", "Brand has been blocked.", "success").then(() => {
          location.reload();
        });
      } else {
        Swal.fire("❌ Error", data.error || "Block failed", "error");
      }
    } catch (err) {
      console.error("Block error:", err);
      Swal.fire("❌ Error", err.message, "error");
    }
  }



    // Unblock Brand
      async function unblockBrand(id) {
    try {
      const res = await fetch(`/admin/unblockBrand/${id}`, { method: "PATCH", credentials: "same-origin" });
      const data = await res.json();
      if (data.success) {
        Swal.fire("✅ Unblocked", "Brand has been unblocked.", "success").then(() => {
          location.reload();
        });
      } else {
        Swal.fire("❌ Error", data.error || "Unblock failed", "error");
      }
    } catch (err) {
      console.error("Unblock error:", err);
      Swal.fire("❌ Error", err.message, "error");
      }
    }
  </script>